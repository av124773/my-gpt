# =================================================================
# GitHub Actions Workflow for Vue.js SPA Deployment to AWS
# =================================================================
# æ­¤ Workflow æœƒåœ¨ main åˆ†æ”¯æœ‰ push æ™‚è§¸ç™¼ï¼Œè‡ªå‹•å»ºç½® Vue.js æ‡‰ç”¨ç¨‹å¼
# ä¸¦éƒ¨ç½²åˆ° AWS S3ï¼ŒåŒæ™‚æ¸…é™¤ CloudFront å¿«å–

name: Deploy Vue.js App to AWS

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ main åˆ†æ”¯æœ‰ push æ™‚è‡ªå‹•åŸ·è¡Œ
on:
  push:
    branches: [main]
  # ä¹Ÿå¯ä»¥æ‰‹å‹•è§¸ç™¼ workflow
  workflow_dispatch:

# è¨­å®šç’°å¢ƒè®Šæ•¸ï¼Œæ–¹ä¾¿çµ±ä¸€ç®¡ç†
env:
  # å¾ä½ çš„ CloudFormation ç¯„æœ¬ä¸­ç²å–é€™äº›å€¼
  AWS_REGION: us-east-1        # è«‹æ ¹æ“šä½ çš„ AWS å€åŸŸèª¿æ•´
  PROJECT_NAME: mygptfrontend  # èˆ‡ CloudFormation ä¸­çš„ ProjectName åƒæ•¸ä¸€è‡´
  STACK_NAME: StrayCatLFrontendStack
  DOMAIN_NAME: straycatl.com   # ä½ çš„ç¶²åŸŸåç¨±
  NODE_VERSION: '18'           # Node.js ç‰ˆæœ¬ï¼Œå»ºè­°ä½¿ç”¨ LTS ç‰ˆæœ¬

# å®šç¾©å·¥ä½œæµç¨‹
jobs:
  # =================================================================
  # å·¥ä½œ 1: å»ºç½®å’Œéƒ¨ç½²åˆ° AWS
  # =================================================================
  deploy:
    name: Build and Deploy to AWS
    runs-on: ubuntu-latest
    
    # è¨­å®š OIDC æ¬Šé™ï¼Œé€™æ˜¯ä½¿ç”¨ AWS OIDC çš„é—œéµè¨­å®š
    # ä½ç½®äºŒ
    permissions:
      id-token: write   # å…è¨± GitHub Actions å»ºç«‹ OIDC token
      contents: read    # å…è¨±è®€å– repository å…§å®¹
    
    steps:
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 1: æª¢å‡ºä»£ç¢¼
      # -----------------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç²å–å®Œæ•´çš„ git æ­·å²ï¼Œæœ‰åŠ©æ–¼æŸäº›å»ºç½®å·¥å…·
      
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 2: è¨­å®š Node.js ç’°å¢ƒ
      # -----------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'  # å¿«å– npm å¥—ä»¶ï¼ŒåŠ é€Ÿå»ºç½®
      
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 3: å®‰è£ä¾è³´å¥—ä»¶
      # -----------------------------------------------------------------
      - name: Install Dependencies
        run: |
          npm ci  # ä½¿ç”¨ npm ci è€Œé npm installï¼Œæ›´é©åˆ CI/CD ç’°å¢ƒ
      
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 4: åŸ·è¡Œæ¸¬è©¦ (å¯é¸)
      # -----------------------------------------------------------------
      - name: Run Tests
        run: |
          # å¦‚æœä½ æœ‰æ¸¬è©¦ï¼Œè«‹å–æ¶ˆè¨»è§£ä»¥ä¸‹è¡Œ
          # npm run test:unit
          echo "Tests would run here"
      
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 5: å»ºç½® Vue.js æ‡‰ç”¨ç¨‹å¼
      # -----------------------------------------------------------------
      - name: Build Vue.js Application
        run: |
          npm run build
        env:
          # å¦‚æœä½ çš„ Vue.js æ‡‰ç”¨ç¨‹å¼éœ€è¦ç‰¹å®šçš„ç’°å¢ƒè®Šæ•¸ï¼Œåœ¨é€™è£¡è¨­å®š
          NODE_ENV: production
          # VUE_APP_API_URL: ${{ secrets.VUE_APP_API_URL }}
      
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 6: é…ç½® AWS æ†‘è­‰ (ä½¿ç”¨ OIDC)
      # -----------------------------------------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # ä½¿ç”¨ OIDC è€Œéå‚³çµ±çš„ access key
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          # è¨­å®š session åç¨±ï¼Œæœ‰åŠ©æ–¼ CloudTrail è¿½è¹¤
          role-session-name: GitHubActions-${{ github.run_number }}
      
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 7: åŒæ­¥æª”æ¡ˆåˆ° S3 å„²å­˜æ¡¶
      # -----------------------------------------------------------------
      - name: Deploy to S3
        run: |
          # æ§‹å»º S3 å„²å­˜æ¡¶åç¨±ï¼ˆèˆ‡ CloudFormation ç¯„æœ¬ä¸€è‡´ï¼‰
          BUCKET_NAME="${{ env.PROJECT_NAME }}-${{ secrets.AWS_ACCOUNT_ID }}-root-content"
          
          echo "Deploying to S3 bucket: $BUCKET_NAME"
          
          # åŒæ­¥å»ºç½®å¾Œçš„æª”æ¡ˆåˆ° S3
          aws s3 sync dist/ s3://$BUCKET_NAME/ \
            --delete \
            --exact-timestamps \
            --cache-control "public,max-age=31536000" \
            --metadata-directive REPLACE
          
          # ç‚º HTML æª”æ¡ˆè¨­å®šä¸åŒçš„å¿«å–ç­–ç•¥
          aws s3 cp dist/index.html s3://$BUCKET_NAME/index.html \
            --cache-control "public,max-age=0,must-revalidate" \
            --metadata-directive REPLACE
          
          echo "âœ… Files uploaded to S3 successfully"
      
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 8: æ¸…é™¤ CloudFront å¿«å–
      # -----------------------------------------------------------------
      - name: Invalidate CloudFront Cache
        run: |
          # ç²å– CloudFront Distribution ID
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionID'].OutputValue" \
            --output text)
          
          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "âŒ Could not find CloudFront Distribution ID"
            exit 1
          fi
          
          echo "Invalidating CloudFront Distribution: $DISTRIBUTION_ID"
          
          # å»ºç«‹ CloudFront å¿«å–å¤±æ•ˆè«‹æ±‚
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*" \
            --query "Invalidation.Id" \
            --output text)
          
          echo "âœ… CloudFront invalidation created: $INVALIDATION_ID"
          
          # ç­‰å¾…å¿«å–å¤±æ•ˆå®Œæˆ (å¯é¸)
          echo "â³ Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id $DISTRIBUTION_ID \
            --id $INVALIDATION_ID
          
          echo "âœ… CloudFront cache invalidation completed"
      
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 9: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      # -----------------------------------------------------------------
      - name: Deployment Success Notification
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Your website is now live at: https://${{ env.DOMAIN_NAME }}"
          echo "ğŸ“Š GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      
      # -----------------------------------------------------------------
      # æ­¥é©Ÿ 10: éƒ¨ç½²å¤±æ•—è™•ç† (åªåœ¨å¤±æ•—æ™‚åŸ·è¡Œ)
      # -----------------------------------------------------------------
      - name: Deployment Failure Notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Please check the logs above for details"
          echo "ğŸ“Š GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
